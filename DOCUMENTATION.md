# Система Контроля Посещаемости Студентов (СКПС) - Документация

## Обзор проекта

СКПС (Student Attendance Control System) - это система контроля посещаемости студентов во время приемов пищи в учебном заведении. Система использует RFID-карты для идентификации студентов и позволяет отслеживать, кто из зарегистрированных студентов пришел на обед, завтрак или ужин. Основной интерфейс реализован в виде графического приложения (GUI) на базе Tkinter, которое объединяет все функции в едином окне с вкладками. Консольные скрипты доступны как альтернативные инструменты для автоматизации или использования без GUI.

### Основные возможности
- **Графический интерфейс (GUI)**: Основное окно с двумя вкладками - "Проверка посещаемости" и "Настройки". Вкладка "Настройки" предоставляет доступ к подокнам для управления студентами, регистрацией и отчетами
- **Проверка посещаемости**: Проверка доступа студента к приему пищи по ID карты с автоматическим определением текущего приема. Поддержка доступа без предварительной регистрации
- **Управление студентами**: Добавление, редактирование и удаление информации о студентах, включая импорт из XLSX-файлов с поддержкой групп
- **Регистрация на приемы пищи**: Регистрация студентов на конкретные приемы пищи по дням недели с возможностью массового выбора и импорта из Excel
- **Отчеты о посещаемости**: Экспорт общей таблицы посещаемости в Excel с цветовым кодированием (желтый - не пришел, оранжевый - пришел без регистрации, красный - низкий процент посещаемости)
- **База данных SQLite**: Хранение всей информации в локальной базе данных с поддержкой внешних ключей
- **Импорт/Экспорт данных**: Поддержка импорта студентов и регистраций из Excel-файлов, экспорт отчетов в Excel

## Установка и настройка

### Требования
- Python 3.x
- SQLite3 (обычно включен в Python)
- pip (для установки зависимостей)

### Быстрая установка и запуск
Для быстрого развертывания на новом устройстве:
1. Скачайте или клонируйте проект.
2. Запустите лаунчер:
   ```bash
   python launcher.py
   ```
   Это автоматически установит необходимые зависимости (openpyxl), инициализирует базу данных и запустит GUI-приложение.

### Ручная установка зависимостей
Если предпочитаете ручную установку:
1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Инициализируйте базу данных:
   ```bash
   python db/init_db.py
   ```
   Это создаст файл `skud.db` с необходимыми таблицами и заполнит таблицу приемов пищи стандартными значениями (завтрак, обед, ужин для каждого дня недели).

### Структура проекта
```
skud_2.0/
├── launcher.py             # Лаунчер для автоматической установки и запуска
├── requirements.txt        # Список зависимостей для установки
├── main.py                 # Основной скрипт запуска GUI-приложения
├── skud.db                 # База данных SQLite
├── DOCUMENTATION.md        # Эта документация
├── TODO.md                 # Список задач для обновления документации
├── db/
│   ├── init_db.py          # Инициализация базы данных
│   ├── student.py          # Функции работы со студентами
│   ├── meals.py            # Функции работы с приемами пищи
│   └── reports.py          # Функции генерации отчетов
└── gui/
    ├── gui.py              # Основной класс GUI-приложения
    ├── attendance_tab.py   # Вкладка проверки посещаемости
    ├── settings_tab.py     # Вкладка настроек с доступом к подокнам
    ├── student_tab.py      # Подокно управления студентами
    ├── registration_tab.py # Подокно регистрации на приемы пищи
    └── reports_tab.py      # Подокно отчетов и экспорта
```

## Использование

### Запуск GUI-приложения
Основной способ взаимодействия с системой - через графический интерфейс:

```bash
python main.py
```

Приложение откроет основное окно с двумя вкладками: "Проверка посещаемости" и "Настройки". База данных инициализируется автоматически при запуске. Вкладка "Настройки" предоставляет доступ к подокнам для управления студентами, регистрацией и отчетами.

### Вкладка "Проверка посещаемости"
Основная функция проверки доступа студентов.

**Работа:**
1. Автоматически определяет текущий прием пищи (на основе времени и дня недели). Кнопка "Обновить" для перерасчета.
2. Введите ID карты студента в поле.
3. Нажмите "Проверить доступ":
   - Если студент зарегистрирован на текущий прием - отображается "ДОСТУП РАЗРЕШЕН" (зеленый), факт посещения записывается.
   - Если студент не зарегистрирован, но карта известна - отображается "ДОСТУП РАЗРЕШЕН (БЕЗ ЗАПИСИ)" (оранжевый), факт посещения записывается.
   - Если карта неизвестна - "ДОСТУП ЗАПРЕЩЕН" (красный).

### Подокно "Управление студентами"
Предназначено для просмотра, добавления, редактирования и удаления студентов. Открывается из вкладки "Настройки".

**Функции:**
- **Просмотр списка**: Таблица со всеми студентами (ID, имя, ID карты, группа). Кнопка "Обновить список" для перезагрузки данных.
- **Добавление студента**: Диалог для ввода имени, группы и ID карты. Студент добавляется в базу.
- **Редактирование**: Выберите студента в таблице, нажмите "Изменить студента" для обновления имени, группы или ID карты.
- **Удаление**: Выберите студента, подтвердите удаление (удаляет студента и все связанные записи).
- **Импорт из XLSX**: Выберите Excel-файл для импорта. Формат: столбцы UID, Имя, Группа. Обновляет существующих студентов или добавляет новых.

### Подокно "Регистрация на приемы пищи"
Для регистрации студентов на приемы пищи по дням. Открывается из вкладки "Настройки".

**Процесс:**
1. Введите ID карты студента и нажмите "Найти студента" для поиска и отображения имени.
2. Выберите день: "Все дни" или конкретный день недели.
3. Нажмите "Загрузить приемы пищи" для отображения списка доступных приемов (завтрак, обед, ужин) для выбранного дня.
4. Выберите один или несколько приемов пищи в списке.
5. Нажмите "Зарегистрировать" для сохранения регистраций.
6. **Импорт из XLSX**: Выберите Excel-файл для импорта регистраций. Формат: начиная с строки 9, столбец 3 - имя студента, столбцы 4+ - регистрации (по 3 столбца на день: завтрак/обед/ужин, значение 1 для регистрации).

### Подокно "Отчеты"
Для генерации и экспорта отчетов о посещаемости. Открывается из вкладки "Настройки".

**Функции:**
- **Экспорт общей таблицы посещаемости в Excel**: Создает подробный отчет в формате Excel с цветовым кодированием:
  - Желтый: студент зарегистрирован, но не пришел
  - Оранжевый: пришел без предварительной регистрации
  - Красный: низкий процент посещаемости (ниже заданного порога)
- Отчет включает сводку по приемам пищи и общие итоги.



## Схема базы данных

### Таблица `students`
Хранит информацию о студентах.

| Поле       | Тип     | Описание              |
|------------|---------|-----------------------|
| id         | INTEGER | Первичный ключ        |
| name       | TEXT   | Имя студента          |
| card_id    | TEXT   | Уникальный ID карты   |
| group_name | TEXT   | Название группы       |

### Таблица `meals`
Хранит информацию о приемах пищи.

| Поле       | Тип     | Описание                    |
|------------|---------|-----------------------------|
| id         | INTEGER | Первичный ключ              |
| name       | TEXT   | Название приема (Breakfast/Lunch/Dinner) |
| start_time | TEXT   | Время начала (HH:MM)        |
| end_time   | TEXT   | Время окончания (HH:MM)     |
| day_of_week| INTEGER| День недели (0=Пн, 6=Вс)    |

### Таблица `registrations`
Связывает студентов с приемами пищи, на которые они зарегистрированы.

| Поле       | Тип     | Описание              |
|------------|---------|-----------------------|
| id         | INTEGER | Первичный ключ        |
| student_id | INTEGER | Ссылка на студента    |
| meal_id    | INTEGER | Ссылка на прием пищи  |

### Таблица `attendance`
Хранит записи о фактической посещаемости.

| Поле       | Тип     | Описание                          |
|------------|---------|-----------------------------------|
| id         | INTEGER | Первичный ключ                    |
| student_id | INTEGER | Ссылка на студента                |
| meal_id    | INTEGER | Ссылка на прием пищи              |
| timestamp  | TEXT   | Время записи посещения            |
| status     | TEXT   | Статус ('came', 'didnt_come', 'came_without_registration') |

## Описание модулей

### launcher.py
- `install_dependencies()`: Проверяет и устанавливает openpyxl при необходимости.
- `initialize_database()`: Вызывает init_db() для создания базы данных.
- `run_gui()`: Запускает GUI-приложение.
- `main()`: Основная функция лаунчера, выполняющая все шаги.

### main.py
- Импортирует и запускает основное GUI-приложение из `gui.gui`.

### gui/gui.py
- `AttendanceSystemGUI`: Основной класс GUI-приложения на базе Tkinter.
  - `__init__()`: Инициализирует основное окно с двумя вкладками и базу данных.
  - `create_attendance_tab()`: Создает вкладку "Проверка посещаемости".
  - `create_settings_tab()`: Создает вкладку "Настройки" с кнопками для открытия подокон.
- `main()`: Запускает GUI-приложение.

### gui/attendance_tab.py
- `AttendanceTab`: Класс вкладки проверки посещаемости.
  - `__init__()`: Инициализирует UI вкладки.
  - `create_ui()`: Создает элементы интерфейса (информация о текущем приеме, поле ввода карты, кнопки).
  - `update_current_meal()`: Обновляет информацию о текущем приеме пищи.
  - `check_attendance()`: Проверяет доступ студента и логирует посещение.
  - `clear_input()`: Очищает поле ввода.

### gui/settings_tab.py
- `SettingsTab`: Класс вкладки настроек.
  - `__init__()`: Инициализирует UI вкладки.
  - `create_ui()`: Создает кнопки для открытия подокон управления.
  - `open_student_management()`: Открывает подокно управления студентами.
  - `open_registration_management()`: Открывает подокно регистрации.
  - `open_export_management()`: Открывает подокно отчетов.

### gui/student_tab.py
- `StudentTab`: Класс подокна управления студентами.
  - `__init__()`: Инициализирует UI подокна.
  - `create_ui()`: Создает таблицу студентов и кнопки управления.
  - `load_students()`: Загружает список студентов в таблицу.
  - `add_student_dialog()`: Диалог добавления нового студента.
  - `edit_student_dialog()`: Диалог редактирования студента.
  - `delete_student()`: Удаление выбранного студента.
  - `import_students_info_from_xlsx()`: Импорт студентов из Excel.

### gui/registration_tab.py
- `RegistrationTab`: Класс подокна регистрации на приемы пищи.
  - `__init__()`: Инициализирует UI подокна.
  - `create_ui()`: Создает элементы интерфейса для поиска студента и выбора приемов.
  - `find_student_for_registration()`: Поиск студента по ID карты.
  - `load_meals_for_registration()`: Загрузка списка приемов пищи для выбранного дня.
  - `register_student()`: Регистрация студента на выбранные приемы.
  - `import_students_from_xlsx()`: Импорт регистраций из Excel.

### gui/reports_tab.py
- `ReportsTab`: Класс подокна отчетов.
  - `__init__()`: Инициализирует UI подокна.
  - `create_ui()`: Создает настройки и кнопку экспорта.
  - `export_all_report_to_excel()`: Экспорт общей таблицы посещаемости в Excel с форматированием.

### db/init_db.py
- `init_db()`: Создает и инициализирует базу данных с необходимыми таблицами
- Заполняет таблицу meals стандартными приемами пищи для всех дней недели

### db/student.py
- `finding_card(card_id)`: Находит ID студента по ID карты
- `student_sheet(student_id, meal_id)`: Проверяет регистрацию студента на прием пищи
- `check_student(card_id, meal_id)`: Проверяет статус студента ('registered', 'not_registered', 'unknown_card')
- `log_attendance(student_id, meal_id, status)`: Записывает факт посещения ('came', 'didnt_come', 'came_without_registration')
- `add_student(name, card_id, group_name)`: Добавляет нового студента с группой
- `add_registration(student_id, meal_id)`: Регистрирует студента на прием пищи
- `get_all_students()`: Возвращает список всех студентов с группами
- `update_student(student_id, name, card_id, group_name)`: Обновляет информацию о студенте
- `find_student_by_name_group(name, group_name)`: Поиск студента по имени и группе
- `find_student_by_name(name)`: Поиск студента по имени
- `delete_student(student_id)`: Удаляет студента и связанные записи с поддержкой внешних ключей

### db/meals.py
- `get_current_meal()`: Определяет текущий прием пищи на основе времени и дня недели
- `get_meal_name(meal_id)`: Возвращает название приема пищи по ID

### db/reports.py
- `get_attendance_report(meal_id, day_of_week)`: Генерирует отчет по посещаемости для конкретного приема пищи (устаревшая функция)
- `get_all_attendance_records()`: Возвращает все записи о посещаемости для формирования общей таблицы с учетом статуса 'came_without_registration'

## Замечания по разработке

### Добавление новых функций
- Все операции с базой данных вынесены в отдельные модули в папке `db/`
- Для добавления новых типов отчетов модифицируйте `db/reports.py` и соответствующие методы в `gui/reports_tab.py`
- Для изменения логики проверки посещаемости редактируйте `db/student.py` и метод `check_attendance()` в `gui/attendance_tab.py`
- Для расширения GUI добавляйте новые подокна в `gui/settings_tab.py` и соответствующие классы в папке `gui/`
- Импорт из XLSX: Поддерживаются различные форматы файлов. Для студентов: столбцы UID, Имя, Группа. Для регистраций: начиная с строки 9, столбец C (3) - имя студента, столбцы D+ - регистрации (по 3 столбца на день: завтрак/обед/ужин, значение 1 для регистрации)

### Безопасность
- ID карт должны быть уникальными
- Включены внешние ключи для поддержания целостности данных
- Рекомендуется регулярное резервное копирование файла `skud.db`
- При импорте XLSX проверяйте источник файла на безопасность

### Расширение системы
Возможные улучшения:
- Веб-интерфейс для управления системой (альтернатива GUI)
- Интеграция с RFID-ридерами для автоматического считывания карт
- Экспорт отчетов в дополнительные форматы (PDF, CSV)
- Темизация GUI (светлая/темная тема, кастомные цвета)
- Уведомления о пропусках приемов пищи (email/SMS интеграция)
- Статистика посещаемости по периодам (графики, диаграммы в GUI)
- Реальное время обновления данных в GUI (автообновление списков)
- Логирование действий пользователей для аудита
- Поддержка нескольких учебных заведений в одной базе данных
